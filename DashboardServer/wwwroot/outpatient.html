<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–æ¥æ‚£è€…æ•°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="/css/outpatient.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <h1>ğŸ“Š å¤–æ¥æ‚£è€…æ•°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <nav class="nav-links">
                <a href="/">ğŸ  ãƒˆãƒƒãƒ—</a>
                <a href="/inpatient.html">å…¥é™¢æ‚£è€…</a>
                <a href="/outpatient.html" class="active">å¤–æ¥æ‚£è€…</a>
            </nav>
        </header>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <div class="control-group">
                <label>
                    <span class="label-icon">ğŸ¥</span>
                    <span class="label-text">è¨ºç™‚ç§‘</span>
                </label>
                <div class="button-group">
                    <button class="btn-option active" data-value="å…¨ç§‘">å…¨ç§‘</button>
                    <button class="btn-option" data-value="å…¨ç§‘(è‰²åˆ†)">å…¨ç§‘(è‰²åˆ†)</button>
                    <button class="btn-option" data-value="å†…ç§‘">å†…ç§‘</button>
                    <button class="btn-option" data-value="å°å…ç§‘">å°å…ç§‘</button>
                    <button class="btn-option" data-value="æ•´å½¢å¤–ç§‘">æ•´å½¢å¤–ç§‘</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    <span class="label-icon">ğŸ“…</span>
                    <span class="label-text">æœŸé–“ç¨®åˆ¥</span>
                </label>
                <div class="button-group">
                    <button class="btn-option" data-value="å¹´æ¯">å¹´æ¯</button>
                    <button class="btn-option" data-value="æœˆæ¯">æœˆæ¯</button>
                    <button class="btn-option active" data-value="æ—¥æ¯">æ—¥æ¯</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    <span class="label-icon">ğŸ“†</span>
                    <span class="label-text">æœŸé–“é¸æŠ</span>
                </label>
                <div class="date-range">
                    <input type="date" id="startDate" value="2025-01-01">
                    <span class="date-separator">ã€œ</span>
                    <input type="date" id="endDate" value="2025-10-31">
                </div>
            </div>

            <div class="control-group">
                <button id="updateBtn" class="btn-update">
                    <span>ğŸ”„</span> ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                </button>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="outpatientChart"></canvas>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">ç·æ‚£è€…æ•°</div>
                <div class="stat-value" id="totalPatients">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡æ‚£è€…æ•°/æ—¥</div>
                <div class="stat-value" id="avgPatients">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€å¤§æ‚£è€…æ•°</div>
                <div class="stat-value" id="maxPatients">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€å°æ‚£è€…æ•°</div>
                <div class="stat-value" id="minPatients">-</div>
            </div>
        </div>
    </div>

    <script src="/js/chart.min.js"></script>
    <script>
        let chart = null;
        let selectedDepartment = 'å…¨ç§‘';
        let selectedPeriod = 'æ—¥æ¯';

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadChartData();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // è¨ºç™‚ç§‘é¸æŠãƒœã‚¿ãƒ³
            document.querySelectorAll('.control-group:nth-child(1) .btn-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.control-group:nth-child(1) .btn-option').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedDepartment = this.dataset.value;
                    loadChartData();
                });
            });

            // æœŸé–“ç¨®åˆ¥é¸æŠãƒœã‚¿ãƒ³
            document.querySelectorAll('.control-group:nth-child(2) .btn-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.control-group:nth-child(2) .btn-option').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedPeriod = this.dataset.value;
                    loadChartData();
                });
            });

            // æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('updateBtn').addEventListener('click', loadChartData);

            // æ—¥ä»˜å¤‰æ›´æ™‚
            document.getElementById('startDate').addEventListener('change', loadChartData);
            document.getElementById('endDate').addEventListener('change', loadChartData);
        }

        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadChartData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const params = new URLSearchParams({
                    department: selectedDepartment,
                    period: selectedPeriod,
                    startDate: startDate,
                    endDate: endDate
                });

                const response = await fetch(`/api/dashboard/outpatient?${params}`);
                if (!response.ok) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

                const data = await response.json();
                renderChart(data);
                updateStats(data);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚°ãƒ©ãƒ•æç”»
        function renderChart(data) {
            const ctx = document.getElementById('outpatientChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const isStacked = selectedDepartment === 'å…¨ç§‘(è‰²åˆ†)';

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets.map(ds => ({
                        label: ds.label,
                        data: ds.data,
                        borderColor: ds.borderColor,
                        backgroundColor: ds.backgroundColor,
                        fill: ds.fill,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: data.labels.length > 100 ? 0 : 3,
                        pointHoverRadius: 5
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: data.title,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toLocaleString() + 'äºº';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: getPeriodLabel()
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ‚£è€…æ•°ï¼ˆäººï¼‰'
                            },
                            stacked: isStacked,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'äºº';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æœŸé–“ãƒ©ãƒ™ãƒ«å–å¾—
        function getPeriodLabel() {
            switch (selectedPeriod) {
                case 'å¹´æ¯': return 'å¹´';
                case 'æœˆæ¯': return 'å¹´æœˆ';
                default: return 'æ—¥ä»˜';
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(data) {
            let allValues = [];
            data.datasets.forEach(ds => {
                allValues = allValues.concat(ds.data);
            });

            const total = allValues.reduce((sum, val) => sum + val, 0);
            const avg = allValues.length > 0 ? Math.round(total / data.labels.length) : 0;
            const max = allValues.length > 0 ? Math.max(...allValues) : 0;
            const min = allValues.length > 0 ? Math.min(...allValues) : 0;

            document.getElementById('totalPatients').textContent = total.toLocaleString() + 'äºº';
            document.getElementById('avgPatients').textContent = avg.toLocaleString() + 'äºº';
            document.getElementById('maxPatients').textContent = max.toLocaleString() + 'äºº';
            document.getElementById('minPatients').textContent = min.toLocaleString() + 'äºº';
        }

        // å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆ5åˆ†ã”ã¨ï¼‰
        setInterval(loadChartData, 300000);
    </script>
</body>
</html>
